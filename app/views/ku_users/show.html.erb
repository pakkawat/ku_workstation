<!-- Main -->
<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12">
      <strong>Pakkawat Jongprasertkit</strong>
      <% if current_user.admin? %>
        <span class="pull-right"><%= button_to "View files", ku_user_path(@kuuser)+"/cookbook/"+@kuuser.ku_id+"/", :class => "btn btn-success", :method => :get %></span>
      <% end %>
      <hr>
      <div class="row">
        <div class="col-md-6">
          <% if !@node.nil? %>
            <div class="panel panel-default">
              <div class="panel-body">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Remote</th>
                      <th>Instance name</th>
                      <th>Uptime</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <th><a class="btn btn-primary" href='<%= "http://"+@node.ec2.public_hostname.to_s+":8080/guacamole" %>'>RDP</a></th>
                      <th><%= @node.name %></th>
                      <th><%= @node.uptime.split(" ")[0..1].join(" ") %></th>
                      <% date = DateTime.parse(Time.at(@node[:ohai_time]).to_s) %>
                      <% if date < 1.hour.ago %>
                        <th><%= image_tag "error.png" %> error</th>
                      <% else %>
                        <th><%= image_tag "running.png" %> running</th>
                      <% end %>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          <% end %>

          <hr>

          <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">
            <%= button_to [:apply_change, @kuuser], :class => "btn btn-primary", :method => :get, :disabled => @result.any? ? true : false do %>
              Apply change
              <% if @was_updated != 0 %>
                <%= content_tag :span, @was_updated, class: 'badge' %>
              <% end %>
            <% end %>
          </div>

          <hr>

          <% if @result.any? %>
            <% progress=0 %>
            <% if @user_job.progress_max != 0 %>
            	<% progress = ((@user_job.progress_current.to_f / @user_job.progress_max) * 100).round %>
            <% end %>
            <div class="thumbnail" style="padding: 0">
              <div class="caption">
                <div class="row">
                  <div class="col-md-4"  style="text-align:center">
                    <% if @user_job.progress_stage.nil? %>
                      <b>Waitting</b>
                    <% else %>
                      <% if @job_error %>
                        <b>Error</b>
                      <% else %>
                        <b>Working</b>
                      <% end %>
                    <% end %>
                    <br><small>Status</small></div>
                  <div class="col-md-4"  style="text-align:center"><%= button_to 'Log', log_path(@kuuser.log), :class => "btn btn-default", :method => :get, :disabled =>  @job_error ? false : true  %></div>
                  <div class="col-md-4"  style="text-align:center"><%= button_to 'Delete', delete_user_job_path(id: @kuuser.id, job_id: @user_job.id), :class => "btn btn-default pull-right", :method => :delete, :disabled =>  @job_error ? false : true  %></div>
                </div>
              </div>
              <div class="modal-footer" style="text-align: left">
              	<div class="progress">
      	          	<% if @job_error %>
      	            	<%= content_tag(:div, progress.to_s + "%", :style => "width:"+progress.to_s+"%;", :class => "progress-bar progress-bar-danger") %>
      	            <% else %>
      	            	<%= content_tag(:div, progress.to_s + "%", :style => "width:"+progress.to_s+"%;", :class => "progress-bar") %>
      	            <% end %>
                  </div>
              </div>
              <div class="row">
                  <div class="col-md-4" style="text-align:center"><%= ("<b>"+progress.to_s+"%</b>").html_safe %><br/><small>Successed</small></div>
                  <div class="col-md-4" style="text-align:center"><%= ("<b>"+@user_job.progress_current.to_s+"</b>").html_safe %><br/><small>Current</small></div>
                  <div class="col-md-4" style="text-align:center"><%= ("<b>"+@user_job.progress_max.to_s+"</b>").html_safe %><br/><small>Max</small></div>
              </div>


            </div>
          <% end %>

        </div><!-- col-sm-6 -->

        <div class="col-md-6">
          <ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#personal_programs">Personal programs</a></li>
            <li><a data-toggle="tab" href="#all_personal_programs">All personal programs</a></li>
            <li><a data-toggle="tab" href="#subjects">Subjects</a></li>
            <li><a data-toggle="tab" href="#programs">Programs</a></li>
          </ul>

          <div class="tab-content">

            <div id="personal_programs" class="tab-pane fade in active">
              <br>
              <div class="panel panel-primary">
                <!-- Default panel contents -->
                <div class="panel-heading">Personal programs</div>
                  <table class="datatable_display table table-striped">
                    <thead>
                      <tr>
                        <th></th>
                        <th>Program name</th>
                        <th>Note</th>
                        <th>Edit</th>
                        <th>Delete</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @kuuser.personal_programs.each do |program| %>
                        <tr>
                          <th scope="row">
                            <% state = @kuuser.user_personal_programs.where(personal_program_id: program.id).pluck("state").first %>
                            <% if state != "none" %>
                              <% if state == "uninstall" %>
                                <span class="label label-danger">uninstall</span>
                              <% else %>
                                <span class="label label-success"><%= state %></span>
                              <% end %>
                            <% end %>
                          </th>
                          <td><%= program.program_name %></td>
                          <td><%= program.note %></td>
                          <td><%= button_to "Edit", edit_personal_program_path(program), :class => "btn btn-primary", :method => :get %></td>
                          <td>
                            <% if state == "uninstall" %>
                              <%= button_to 'Add', ku_user_add_personal_program_path(@kuuser, program), :class => "btn btn-success", :method => :post %>
                            <% else %>
                              <%= button_to 'Delete', ku_user_delete_personal_program_path(@kuuser, program), :class => "btn btn-default", :method => :delete %>
                            <% end %>
                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                </table>
              </div>

              <!-- Button trigger modal -->
              <button class="btn btn-primary" data-toggle="modal" data-target="#personal_program_Modal">
                Create program
              </button>
              <!-- Modal -->
              <div class="modal fade" id="personal_program_Modal" tabindex="-1" role="dialog" aria-labelledby="personal_program_Modal_Label" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <%= form_tag ku_user_create_personal_program_path, method: :post, :class => "form-horizontal" do %>
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title">Personal Program</h4>
                      </div>
                      <div class="modal-body">
                              <%= label_tag 'name', 'Program name', :class => 'control-label' %>
                              <%= text_field_tag :program_name, params[:program_name], :class => "form-control" %>
                              <br>
                              <%= label_tag 'note', 'Program note', :class => 'control-label' %>
                              <%= text_area_tag :note, params[:note], :class => "form-control" %>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                           <%= submit_tag "Create program", name: nil, class: "btn btn-success" %>
                      </div>
                    <% end %>
                  </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
              </div><!-- /.modal -->

            </div>


            <div id="all_personal_programs" class="tab-pane fade">
              <br>
              <div class="panel panel-primary">
                <!-- Default panel contents -->
                <div class="panel-heading">All personal programs</div>
                  <table class="datatable_display table table-striped">
                    <thead>
                      <tr>
                        <th>Program ID</th>
                        <th>Program name</th>
                        <th>Note</th>
                        <th>Edit</th>
                        <th>Delete</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @all_personal_programs.each do |program| %>
                        <tr>
                          <th scope="row"><%= program.id %></th>
                          <td><%= program.program_name %></td>
                          <td><%= program.note %></td>
                          <td><%= button_to "Edit", edit_personal_program_path(program), :class => "btn btn-primary", :method => :get %></td>
                          <td><%= button_to 'Add', ku_user_add_personal_program_path(@kuuser, program), :class => "btn btn-success", :method => :post %></td>
                        </tr>
                      <% end %>
                    </tbody>
                </table>
              </div>
            </div>


            <div id="subjects" class="tab-pane fade">
              <br>
              <div class="panel panel-info">
                <!-- Default panel contents -->
                <div class="panel-heading">Subjects</div>
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Subject ID</th>
                        <th>Subject name</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @kuuser.subjects.where("user_subjects.user_enabled = true").each do |subject| %>
                        <tr>
                          <th scope="row"><%= subject.id %></th>
                          <td><%= link_to subject.subject_name, subject %></td>
                        </tr>
                      <% end %>
                    </tbody>
                </table>
              </div>
            </div>

            <div id="programs" class="tab-pane fade">
              <br>
              <div class="panel panel-warning">
                <!-- Default panel contents -->
                <div class="panel-heading">Programs</div>
                  <table class="table table-striped">
                    <thead>
                      <tr>

                        <th>Program name</th>

                        <th>Configure</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% @user_programs.each do |program| %>
                        <tr>
                          <th scope="row"><%= link_to program.program_name, program %></th>
                          <td>
                            <% chef_attributes = ChefAttribute.where(chef_resource_id: program.chef_resources.select("id")) %>
                            <% @chef_values = ChefValue.where(chef_attribute_id: chef_attributes, ku_user_id: @kuuser) %>

                            <% if !@chef_values.empty? %>
                            <!-- Button trigger modal -->
                            <button class="btn btn-primary" data-toggle="modal" data-target="#program_<%= program.id %>_attributes_Modal">
                              Edit
                            </button>
                            <!-- Modal -->
                            <div class="modal fade" id="program_<%= program.id %>_attributes_Modal" tabindex="-1" role="dialog" aria-labelledby="program_<%= program.id %>_attributes_Modal_Label" aria-hidden="true">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <%= form_for(@kuuser, :url => update_ku_user_attribute_path, :method => :patch) do |user_form| %>
                                    <div class="modal-header">
                                      <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                      <h4 class="modal-title"><%= program.program_name %></h4>
                                    </div>
                                    <div class="modal-body">
                                        <% @chef_values.each do |chef_value| %>
                                          <%= user_form.fields_for chef_value, index: chef_value.id do |c| %>
                                            <%= label_tag 'name', ChefAttribute.find(c.object.chef_attribute_id).name, :class => 'control-label' %>
                                            <%= c.text_field :value, :class => "form-control" %>
                                            <br>
                                          <% end %>
                                        <% end %>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-danger" data-dismiss="modal">Cancel</button>
                                      <%= submit_tag "Update", class: "btn btn-success" %>
                                    </div>
                                  <% end %>
                                </div><!-- /.modal-content -->
                              </div><!-- /.modal-dialog -->
                            </div><!-- /.modal -->
                            <% end %>

                          </td>
                        </tr>
                      <% end %>
                    </tbody>
                </table>
              </div>
            </div>


          </div><!--tab-content-->
        </div><!-- col-sm-6 -->

      </div><!-- row -->
    </div><!-- col-sm-12 -->
  </div><!-- row -->
</div>
<!-- Main -->
